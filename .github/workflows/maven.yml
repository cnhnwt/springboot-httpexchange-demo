name: Generate & Build Client SDK

on:
  push:
    branches: [ "main" ]
    # 只有当以下文件变化时才自动触发，避免修改 README 也跑一遍构建
    paths:
      - 'openapi-httpexchange-sdk-generator/**'
      - 'pom.xml'
      - 'src/**'
  workflow_dispatch: # 允许手动点击按钮触发

jobs:
  generate-sdk:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 拉取代码
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. 配置 Java 21 (LTS)
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'      # 指定 JDK 21
        distribution: 'temurin' # 推荐使用 Eclipse Temurin (最常用的 OpenJDK 发行版)
        cache: 'maven'          # 开启 Maven 缓存，加速后续构建

    # 3. 赋予 mvnw 执行权限 (防止 Linux 环境下报错 Permission denied)
    - name: Grant execute permission for mvnw
      run: chmod +x mvnw

    # 4. 【核心步骤一】构建整个项目，安装依赖到本地仓库
    # 对应 README: ./mvnw clean install -DskipTests
    # 必须先做这一步，否则生成 SDK 时会找不到依赖
    - name: Install Dependencies (Root Build)
      run: ./mvnw clean install -DskipTests

    # 5. 【核心步骤二】生成客户端 SDK
    # 对应 README: 从本地 OpenAPI 文件生成
    # 这里的路径和参数完全照搬了你的 README
    - name: Generate SDK from OpenAPI
      working-directory: ./openapi-httpexchange-sdk-generator
      run: |
        ../mvnw clean install \
          -Dopenapi.file.path=openapi/httpexchange-server@0.0.1-SNAPSHOT.json

    # 6. 上传构建产物
    # 构建成功后，你可以在 Actions 页面底部下载到打好的 jar 包
    - name: Upload SDK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: httpexchange-client-sdk
        # 收集生成器 target 目录下的 jar 包
        # 使用 ! 排除源码包和文档包，只保留主 jar 包
        path: |
          openapi-httpexchange-sdk-generator/**/target/*.jar
          !openapi-httpexchange-sdk-generator/**/target/*-sources.jar
          !openapi-httpexchange-sdk-generator/**/target/*-javadoc.jar
        retention-days: 7
